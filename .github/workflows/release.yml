name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build-macos:
    name: Build macOS ARM + Intel
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add targets
        run: |
          rustup target add aarch64-apple-darwin
          rustup target add x86_64-apple-darwin

      # Build ARM
      - name: Build ARM64
        run: cargo build --release --target aarch64-apple-darwin

      - name: Package ARM64
        run: |
          mkdir -p dist
          cp target/aarch64-apple-darwin/release/tilt-logs dist/tilt-logs
          tar -czvf tilt-logs-aarch64-apple-darwin.tar.gz -C dist tilt-logs

      # Build Intel
      - name: Build Intel
        run: cargo build --release --target x86_64-apple-darwin

      - name: Package Intel
        run: |
          rm dist/tilt-logs
          cp target/x86_64-apple-darwin/release/tilt-logs dist/tilt-logs
          tar -czvf tilt-logs-x86_64-apple-darwin.tar.gz -C dist tilt-logs

      # SHA256
      - name: Compute SHA256
        id: shas
        run: |
          echo "arm64_sha=$(shasum -a 256 tilt-logs-aarch64-apple-darwin.tar.gz | cut -d ' ' -f1)" >> $GITHUB_OUTPUT
          echo "intel_sha=$(shasum -a 256 tilt-logs-x86_64-apple-darwin.tar.gz | cut -d ' ' -f1)" >> $GITHUB_OUTPUT

      # Update formula
      - name: Patch Homebrew Formula
        run: |
          sed -i "s/REPLACE_WITH_REAL_SHA256/${{ steps.shas.outputs.arm64_sha }}/" Formula/tilt-logs.rb
          sed -i "0,/REPLACE_WITH_REAL_SHA256/s//${{ steps.shas.outputs.intel_sha }}/" Formula/tilt-logs.rb

      # Switch from detached HEAD â†’ main branch
      - name: Switch to main branch
        run: |
          git fetch origin main
          git checkout main
          git pull origin main

      # Apply and commit formula update to main
      - name: Commit formula change
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update Homebrew formula checksums"
          add_options: "--all"
          push_options: "--force"

      # Upload assets
      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            tilt-logs-aarch64-apple-darwin.tar.gz
            tilt-logs-x86_64-apple-darwin.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
